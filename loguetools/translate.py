"""
Korg's midi tables for the minilogues; XD and original (OG). I added a couple of notes, labelled Gn

Minilogue XD                                                                 Minilogue OG
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|  Offset |  Bit  |  Range  |  Description                                |  | Offset|  Bit  |  Range  |  Description                                |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   0~3   |       |  ASCII  |  'PROG'                                     |  |  0~3  |       |  ASCII  |  'PROG'                                     |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   4~15  |       |  ASCII  |  PROGRAM NAME [12]                 *note P1 |  |  4~15 |       |  ASCII  |  PROGRAM NAME [12]                          |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   16    |       |  0~4    |  OCTAVE                           0~4=-2~+2 |  | 16~19 |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   17    |       |  0,1    |  PORTAMENTO *note G1                  0~127 |  |  20   |  0~7  |         |  VCO 1 PITCH (bit2~9)           *note P1,P2 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   18    |       |  0,1    |  KEY TRIG                        0,1=Off,On |  |  21   |  0~7  |         |  VCO 1 SHAPE (bit2~9)              *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   19    | H:0~7 |  0~1023 |  VOICE MODE DEPTH                  *note P2 |  |  22   |  0~7  |         |  VCO 2 PITCH (bit2~9)           *note P1,P2 |
|   20    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  23   |  0~7  |         |  VCO 2 SHAPE (bit2~9)              *note P1 |
|   21    |       |  1~4    |  VOICE MODE TYPE *note G2          *note P3 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  24   |  0~7  |         |  CROSS MOD DEPTH (bit2~9)          *note P1 |
|   22    |       |  0~2    |  VCO 1 WAVE                        *note P4 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  25   |  0~7  |         |  VCO 2 PITCH EG INT (bit2~9)    *note P1,P3 |
|   23    |       |  0~3    |  VCO 1 OCTAVE              0~3=16',8',4',2' |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  26   |  0~7  |         |  VCO 1 LEVEL (bit2~9)              *note P1 |
|   24    | H:0~7 |  0~1023 |  VCO 1 PITCH                       *note P5 |  +-------+-------+---------+---------------------------------------------+
|   25    | L:0~7 |         |                                             |  |  27   |  0~7  |         |  VCO 2 LEVEL (bit2~9)              *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   26    | H:0~7 |  0~1023 |  VCO 1 SHAPE                                |  |  28   |  0~7  |         |  NOISE LEVEL (bit2~9)              *note P1 |
|   27    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  29   |  0~7  |         |  CUTOFF (bit2~9)                   *note P1 |
|   28    |       |  0~2    |  VCO 2 WAVE                        *note P4 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  30   |  0~7  |         |  RESONANCE (bit2~9)                *note P1 |
|   29    |       |  0~3    |  VCO 2 OCTAVE              0~3=16',8',4',2' |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  31   |  0~7  |         |  CUTOFF EG INT (bit2~9)         *note P1,P4 |
|   30    | H:0~7 |  0~1023 |  VCO 2 PITCH                       *note P5 |  +-------+-------+---------+---------------------------------------------+
|   31    | L:0~7 |         |                                             |  |  32   |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   32    | H:0~7 |  0~1023 |  VCO 2 SHAPE                                |  |  33   |  0~7  |  0~127  |  Amp Velocity                               |
|   33    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  34   |  0~7  |         |  AMP EG ATTACK (bit2~9)            *note P1 |
|   34    |       |  0,1    |  SYNC                 0,1=SYNC ON, SYNC OFF |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  35   |  0~7  |         |  AMP EG DECAY (bit2~9)             *note P1 |
|   35    |       |  0,1    |  RING                 0,1=RING ON, RING OFF |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  36   |  0~7  |         |  AMP EG SUSTAIN (bit2~9)           *note P1 |
|   36    | H:0~7 |  0~1023 |  CROSS MOD DEPTH                            |  +-------+-------+---------+---------------------------------------------+
|   37    | L:0~7 |         |                                             |  |  37   |  0~7  |         |  AMP EG RELEASE (bit2~9)           *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   38    |       |  0~2    |  MULTI TYPE              0~2=NOISE,VPM,USER |  |  38   |  0~7  |         |  EG ATTACK (bit2~9)                *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   39    |       |  0~3    |  SELECT NOISE                      *note P6 |  |  39   |  0~7  |         |  EG DECAY (bit2~9)                 *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   40    |       |  0~15   |  SELECT VPM                        *note P7 |  |  40   |  0~7  |         |  EG SUSTAIN (bit2~9)               *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   41    |       |  0~15   |  SELECT USER                       *note P8 |  |  41   |  0~7  |         |  EG RELEASE (bit2~9)               *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   42    | H:0~7 |  0~1023 |  SHAPE NOISE                                |  |  42   |  0~7  |         |  LFO RATE (bit2~9)              *note P1,P5 |
|   43    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  43   |  0~7  |         |  LFO INT (bit2~9)                  *note P1 |
|   44    | H:0~7 |  0~1023 |  SHAPE VPM                                  |  +-------+-------+---------+---------------------------------------------+
|   45    | L:0~7 |         |                                             |  | 44~48 |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   46    | H:0~7 |  0~1023 |  SHAPE USER                                 |  |  49   |  0~7  |         |  DELAY HI PASS CUTOFF (bit2~9)     *note P1 |
|   47    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  50   |  0~7  |         |  DELAY TIME (bit2~9)               *note P1 |
|   48    | H:0~7 |  0~1023 |  SHIFT SHAPE NOISE                          |  +-------+-------+---------+---------------------------------------------+
|   49    | L:0~7 |         |                                             |  |  51   |  0~7  |         |  DELAY FEEDBACK (bit2~9)           *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   50    | H:0~7 |  0~1023 |  SHIFT SHAPE VPM                            |  |  52   |  0~1  |         |  VCO 1 PITCH (bit0~1)           *note P1,P2 |
|   51    | L:0~7 |         |                                             |  |       |  2~3  |         |  VCO 1 SHAPE (bit0~1)              *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  4~5  |  0~3    |  VCO 1 OCTAVE              0~3=16',8',4',2' |
|   52    | H:0~7 |  0~1023 |  SHIFT SHAPE USER                           |  |       |  6~7  |  0~2    |  VCO 1 WAVE                        *note P6 |
|   53    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  53   |  0~1  |         |  VCO 2 PITCH (bit0~1)           *note P1,P2 |
|   54    | H:0~7 |  0~1023 |  VCO1 LEVEL                                 |  |       |  2~3  |         |  VCO 2 SHAPE (bit0~1)              *note P1 |
|   55    | L:0~7 |         |                                             |  |       |  4~5  |  0~3    |  VCO 2 OCTAVE              0~3=16',8',4',2' |
+---------+-------+---------+---------------------------------------------+  |       |  6~7  |  0~2    |  VCO 2 WAVE                        *note P6 |
|   56    | H:0~7 |  0~1023 |  VCO2 LEVEL                                 |  +-------+-------+---------+---------------------------------------------+
|   57    | L:0~7 |         |                                             |  |  54   |  0~1  |         |  CROSS MOD DEPTH (bit0~1)          *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  2~3  |         |  VCO 2 PITCH EG INT (bit0~1)    *note P1,P3 |
|   58    | H:0~7 |  0~1023 |  MULTI LEVEL                                |  |       |  4~5  |         |  VCO 1 LEVEL (bit0~1)              *note P1 |
|   59    | L:0~7 |         |                                             |  |       |  6~7  |         |  VCO 2 LEVEL (bit0~1)              *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   60    | H:0~7 |  0~1023 |  CUTOFF                                     |  |  55   |   0   |  0,1    |  SYNC                            0,1=Off,On |
|   61    | L:0~7 |         |                                             |  |       |   1   |  0,1    |  RING                            0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |       |  2~3  |         |  NOISE LEVEL (bit0~1)              *note P1 |
|   62    | H:0~7 |  0~1023 |  RESONANCE                                  |  |       |  4~5  |         |  CUTOFF (bit0~1)                   *note P1 |
|   63    | L:0~7 |         |                                             |  |       |  6~7  |         |  RESONANCE (bit0~1)                *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   64    |       |  0~2    |  CUTOFF DRIVE                      *note P9 |  |  56   |  0~1  |         |  CUTOFF EG INT (bit0~1)         *note P1,P4 |
+---------+-------+---------+---------------------------------------------+  |       |  2~3  |  0~2    |  CUTOFF VELOCITY                  *note P10 |
|   65    |       |  0~2    |  CUTOFF KEYBOARD TRACK             *note P9 |  |       |  4~5  |  0~2    |  CUTOFF KEYBOARD TRACK            *note P10 |
+---------+-------+---------+---------------------------------------------+  |       |   6   |  0,1    |  CUTOFF TYPE              0,1=2-POLE,4-POLE |
|   66    | H:0~7 |  0~1023 |  AMP EG ATTACK                              |  |       |   7   |  0,1    |  Reserved                                   |
|   67    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  57   |  0~1  |         |  AMP EG ATTACK (bit0~1)            *note P1 |
|   68    | H:0~7 |  0~1023 |  AMP EG DECAY                               |  |       |  2~3  |         |  AMP EG DECAY (bit0~1)             *note P1 |
|   69    | L:0~7 |         |                                             |  |       |  4~5  |         |  AMP EG SUSTAIN (bit0~1)           *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  6~7  |         |  AMP EG RELEASE (bit0~1)           *note P1 |
|   70    | H:0~7 |  0~1023 |  AMP EG SUSTAIN                             |  +-------+-------+---------+---------------------------------------------+
|   71    | L:0~7 |         |                                             |  |  58   |  0~1  |         |  EG ATTACK (bit0~1)                *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  2~3  |         |  EG DECAY (bit0~1)                 *note P1 |
|   72    | H:0~7 |  0~1023 |  AMP EG RELEASE                             |  |       |  4~5  |         |  EG SUSTAIN (bit0~1)               *note P1 |
|   73    | L:0~7 |         |                                             |  |       |  6~7  |         |  EG RELEASE (bit0~1)               *note P1 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   74    | H:0~7 |  0~1023 |  EG ATTACK                                  |  |  59   |  0~1  |         |  LFO RATE (bit0~1)              *note P1,P5 |
|   75    | L:0~7 |         |                                             |  |       |  2~3  |         |  LFO INT (bit0~1)                  *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  4~5  |  0~2    |  LFO TARGET                        *note P7 |
|   76    | H:0~7 |  0~1023 |  EG DECAY                                   |  |       |  6~7  |  0~2    |  LFO EG                            *note P8 |
|   77    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  60   |  0~1  |  0~2    |  LFO WAVE                          *note P6 |
|   78    | H:0~7 |  0~1023 |  EG INT                           *note P10 |  |       |  2~5  |         |  Reserved                                   |
|   79    | L:0~7 |         |                                             |  |       |  6~7  |  0~2    |  DELAY OUTPUT ROUTING              *note P9 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   80    | H:0~7 |  0~2    |  EG TARGET        0~2=CUTOFF, PITCH2, PITCH |  |  61   |  0~7  |  0~128  |  Portament Time          0,1~129=OFF,0~128  |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   81    |       |  0~2    |  LFO WAVE                          *note P4 |  |  62   |  0~1  |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  |       |  2~3  |         |  DELAY HI PASS CUTOFF (bit0~1)     *note P1 |
|   82    |       |  0~2    |  LFO MODE             0~2=1-SHOT,NORMAL,BPM |  |       |  4~5  |         |  DELAY TIME (bit0~1)               *note P1 |
+---------+-------+---------+---------------------------------------------+  |       |  6~7  |         |  DELAY FEEDBACK (bit0~1)           *note P1 |
|   83    | H:0~7 |  0~1023 |  LFO RATE                         *note P11 |  +-------+-------+---------+---------------------------------------------+
|   84    | L:0~7 |         |                                             |  |  63   |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   85    | H:0~7 |  0~1023 |  LFO INT                                    |  |  64   |  0~2  |  0~7    |  VOICE MODE                       *note P11 |
|   86    | L:0~7 |         |                                             |  |       |   3   |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  |       |  4~5  |         |  VOICE MODE DEPTH (bit0~1)     *note P1,P12 |
|   87    |       |  0~2    |  LFO TARGET          0~2=CUTOFF,SHAPE,PITCH |  |       |  6~7  |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   88    |       |  0,1    |  MOD FX ON/OFF                   0,1=Off,On |  |  65   |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   89    |       |  1~5    |  MOD FX TYPE                      *note P12 |  |  66   |  0~3  |  1~12   |  Bend Range (+)                       1~12  |
+---------+-------+---------+---------------------------------------------+  |       |  4~7  |  1~12   |  Bend Range (-)                       1~12  |
|   90    |       |  0~7    |  MOD FX CHORUS                    *note P13 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  | 67~68 |       |         |  Reserved                                   |
|   91    |       |  0~2    |  MOD FX ENSEMBLE                  *note P14 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  69   |   0   |  0,1    |  LFO Key Sync                    0,1=Off,On |
|   92    |       |  0~7    |  MOD FX PHASER                    *note P15 |  |       |   1   |  0,1    |  LFO BPM Sync                    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |       |   2   |  0,1    |  LFO Voice Sync                  0,1=Off,On |
|   93    |       |  0~7    |  MOD FX FLANGER                   *note P16 |  |       |   3   |  0,1    |  Portament BPM                   0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |       |   4   |  0,1    |  Portament Mode                 0,1=Auto,On |
|   94    |       |  0~15   |  MOD FX USER                       *note P8 |  |       |  5~7  |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   95    | H:0~7 |  0~1023 |  MOD FX TIME                                |  |  70   |  0~7  |         |  VOICE MODE DEPTH (bit2~9)     *note P1,P12 |
|   96    | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  71   |  0~7  | 77~127  |  Program Level               77~127=-25~+25 |
|   97    | H:0~7 |  0~1023 |  MOD FX DEPTH                               |  +-------+-------+---------+---------------------------------------------+
|   98    | L:0~7 |         |                                             |  |  72   |  0~7  |  0~79   |  Slider Assign                    *note P13 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   99    |       |  0,1    |  DELAY ON/OFF                    0,1=Off,On |  |  73   |  0~2  |  0~4    |  KEYBOARD OCTAVE                  0~4=-2~+2 |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   100   |       |  0~19   |  DELAY SUB TYPE                   *note P17 |  | 74~95 |       |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   101   | H:0~7 |  0~1023 |  DELAY TIME                                 |  | 96~99 |       | ASCII   |  'SEQD'                                     |
|   102   | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  100  | L:0~7 |100~3000 |  BPM                    100~3000=10.0~300.0 |
|   103   | H:0~7 |  0~1023 |  DELAY DEPTH                                |  |  101  | H:0~3 |         |                                             |
|   104   | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  102  |       |         |  Reserved                                   |
|   105   |       |  0,1    |  REVERB ON/OFF                   0,1=Off,On |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  103  |       |  1~16   |  Step Length                                |
|   106   |       |  0~19   |  REVERB SUB TYPE                  *note P18 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  104  |       | -75~+75 |  Swing                                      |
|   107   | H:0~7 |  0~1023 |  REVERB TIME                                |  +-------+-------+---------+---------------------------------------------+
|   108   | L:0~7 |         |                                             |  |  105  |       |  0~72   |  Default Gate Time             0~72=0%~100% |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   109   | H:0~7 |  0~1023 |  REVERB DEPTH                               |  |  106  |       |  0~4    |  Step Resolution                   *note S1 |
|   110   | L:0~7 |         |                                             |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  107  |       |         |  Reserved                                   |
|   111   |       |  0~12   |  BEND RANGE (+)                 OFF~+12Note |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  108  |   0   |   0,1   |  Step  1 Off/On                  0,1=Off,On |
|   112   |       |  0~12   |  BEND RANGE (-)                 OFF~-12Note |  |  108  |   1   |   0,1   |  Step  2 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  108  |   2   |   0,1   |  Step  3 Off/On                  0,1=Off,On |
|   113   |       |  0~28   |  JOYSTICK ASSIGN (+)              *note P19 |  |  108  |   3   |   0,1   |  Step  4 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  108  |   4   |   0,1   |  Step  5 Off/On                  0,1=Off,On |
|   114   |       |  0~200  |  JOYSTICK RANGE (+)       0~200=-100%~+100% |  |  108  |   5   |   0,1   |  Step  6 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  108  |   6   |   0,1   |  Step  7 Off/On                  0,1=Off,On |
|   115   |       |  0~28   |  JOYSTICK ASSIGN (-)              *note P19 |  |  108  |   7   |   0,1   |  Step  8 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   116   |       |  0~200  |  JOYSTICK RANGE (-)       0~200=-100%~+100% |  |  109  |   0   |   0,1   |  Step  9 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  109  |   1   |   0,1   |  Step 10 Off/On                  0,1=Off,On |
|   117   |       |  0~2    |  CV IN MODE                       *note P20 |  |  109  |   2   |   0,1   |  Step 11 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  109  |   3   |   0,1   |  Step 12 Off/On                  0,1=Off,On |
|   118   |       |  0~28   |  CV IN 1 ASSIGN (+)               *note P19 |  |  109  |   4   |   0,1   |  Step 13 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  109  |   5   |   0,1   |  Step 14 Off/On                  0,1=Off,On |
|   119   |       |  0~200  |  CV IN 1 RANGE (+)        0~200=-100%~+100% |  |  109  |   6   |   0,1   |  Step 15 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  109  |   7   |   0,1   |  Step 16 Off/On                  0,1=Off,On |
|   120   |       |  0~28   |  CV IN 2 ASSIGN (-)               *note P19 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  110  |       |         |  Step 1~8 Switch                   *note S2 |
|   121   |       |  0~200  |  CV IN 2 RANGE (-)        0~200=-100%~+100% |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  111  |       |         |  Step 9~16 Switch                  *note S2 |
|   122   |       |  0~139  |  MICRO TUNING                     *note P21 |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |112~113|       |         |  Motion Slot 1 Parameter           *note S3 |
|   123   |       |  0~24   |  SCALE KEY             0~24=-12Note~+12Note |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |114~115|       |         |  Motion Slot 2 Parameter           *note S3 |
|   124   |       |  0~100  |  PROGRAM TUNING       0~100=-50Cent~+50Cent |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |116~117|       |         |  Motion Slot 3 Parameter           *note S3 |
|   125   |       |  0,1    |  LFO KEY SYNC                    0,1=Off,On |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |118~119|       |         |  Motion Slot 4 Parameter           *note S3 |
|   126   |       |  0,1    |  LFO VOICE SYNC                  0,1=Off,On |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |  120  |   0   |         |  Motion Slot 1 Step  1 Off/On    0,1=Off,On |
|   127   |       |  0~3    |  LFO TARGET OSC                   *note P22 |  |  120  |   1   |         |  Motion Slot 1 Step  2 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  120  |   2   |         |  Motion Slot 1 Step  3 Off/On    0,1=Off,On |
|   128   |       |  0~127  |  CUTOFF VELOCITY                            |  |  120  |   3   |         |  Motion Slot 1 Step  4 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  120  |   4   |         |  Motion Slot 1 Step  5 Off/On    0,1=Off,On |
|   129   |       |  0~127  |  AMP VELOCITY                               |  |  120  |   5   |         |  Motion Slot 1 Step  6 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  120  |   6   |         |  Motion Slot 1 Step  7 Off/On    0,1=Off,On |
|   130   |       |  0~3    |  MULTI OCTAVE              0~3=16',8',4',2' |  |  120  |   7   |         |  Motion Slot 1 Step  8 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  +-------+-------+---------+---------------------------------------------+
|   131   |       |  0,1    |  MULTI ROUTING        0,1=Pre VCF, Post VCF |  |  121  |   0   |         |  Motion Slot 1 Step  9 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  121  |   1   |         |  Motion Slot 1 Step 10 Off/On    0,1=Off,On |
|   132   |       |  0,1    |  EG LEGATO                       0,1=Off,On |  |  121  |   2   |         |  Motion Slot 1 Step 11 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  121  |   3   |         |  Motion Slot 1 Step 12 Off/On    0,1=Off,On |
|   133   |       |  0,1    |  PORTAMENTO MODE                0,1=Auto,On |  |  121  |   4   |         |  Motion Slot 1 Step 13 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  121  |   5   |         |  Motion Slot 1 Step 14 Off/On    0,1=Off,On |
|   134   |       |  0,1    |  PORTAMENTO BPM SYNC             0,1=Off,On |  |  121  |   6   |         |  Motion Slot 1 Step 15 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+  |  121  |   7   |         |  Motion Slot 1 Step 16 Off/On    0,1=Off,On |
|   135   |       | 12~132  |  PROGRAM LEVEL            12~132=-18dB~+6dB |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |122~123|       |         |  Motion Slot 2 Step Off/On (same as Slot 1) |
|   136   |       |  0~200  |  VPM PARAM1 (Feedback)    0~200=-100%~+100% |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |124~125|       |         |  Motion Slot 3 Step Off/On (same as Slot 1) |
|   137   |       |  0~200  |  VPM PARAM2 (Noise Depth) 0~200=-100%~+100% |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |126~127|       |         |  Motion Slot 4 Step Off/On (same as Slot 1) |
|   138   |       |  0~200  |  VPM PARAM3 (ShapeModInt) 0~200=-100%~+100% |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+  |128~147|       |         |  Step 1 Event Data                 *note S4 |
|   139   |       |  0~200  |  VPM PARAM4 (Mod Attack)  0~200=-100%~+100% |  |148~167|       |         |  Step 2 Event Data                 *note S4 |
+---------+-------+---------+---------------------------------------------+  |   :   |       |         |                                             |
|   140   |       |  0~200  |  VPM PARAM5 (Mod Decay)   0~200=-100%~+100% |  |   :   |       |         |                                             |
+---------+-------+---------+---------------------------------------------+  |428~447|       |         |  Step 16 Event Data                *note S4 |
|   141   |       |  0~200  |  VPM PARAM6 (ModKeyTrack) 0~200=-100%~+100% |  +-------+-------+---------+---------------------------------------------+
+---------+-------+---------+---------------------------------------------+
|   142   |       |         |  USER PARAM1                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   143   |       |         |  USER PARAM2                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   144   |       |         |  USER PARAM3                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   145   |       |         |  USER PARAM4                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   146   |       |         |  USER PARAM5                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   147   |       |         |  USER PARAM6                      *note P23 |
+---------+-------+---------+---------------------------------------------+
|   148   |  0~1  |         |  USER PARAM5 TYPE                 *note P24 |
|         |  2~3  |         |  USER PARAM6 TYPE                 *note P24 |
|         |  4~5  |         |  Reserved                                   |
|         |  6~7  |         |  Reserved                                   |
+---------+-------+---------+---------------------------------------------+
|   149   |  0~1  |         |  USER PARAM1 TYPE                 *note P24 |
|         |  2~3  |         |  USER PARAM2 TYPE                 *note P24 |
|         |  4~5  |         |  USER PARAM3 TYPE                 *note P24 |
|         |  6~7  |         |  USER PARAM4 TYPE                 *note P24 |
+---------+-------+---------+---------------------------------------------+
|   150   |       | 1~25    |  PROGRAM TRANSPOSE             -12~+12 Note |
+---------+-------+---------+---------------------------------------------+
|   151   | H:0~7 | 0~1024  |  DELAY DRY WET                              |
|   152   | L:0~7 |         |                                             |
+---------+-------+---------+---------------------------------------------+
|   153   | H:0~7 | 0~1024  |  REVERB DRY WET                             |
|   154   | L:0~7 |         |                                             |
+---------+-------+---------+---------------------------------------------+
|   155   |       |  0~28   |  MIDI AFTER TOUCH ASSIGN          *note P19 |
+---------+-------+---------+---------------------------------------------+
| 156~159 |       |  ASCII  |  'PRED'                                     |
+---------+-------+---------+---------------------------------------------+
| 160~161 |       |  ASCII  |  'SQ'                              *note S1 |
+---------+-------+---------+---------------------------------------------+
|   162   |   0   |   0,1   |  Step  1 Active Step Off/On      0,1=Off,On |
|   162   |   1   |   0,1   |  Step  2 Active Step Off/On      0,1=Off,On |
|   162   |   2   |   0,1   |  Step  3 Active Step Off/On      0,1=Off,On |
|   162   |   3   |   0,1   |  Step  4 Active Step Off/On      0,1=Off,On |
|   162   |   4   |   0,1   |  Step  5 Active Step Off/On      0,1=Off,On |
|   162   |   5   |   0,1   |  Step  6 Active Step Off/On      0,1=Off,On |
|   162   |   6   |   0,1   |  Step  7 Active Step Off/On      0,1=Off,On |
|   162   |   7   |   0,1   |  Step  8 Active Step Off/On      0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   163   |   0   |   0,1   |  Step  9 Active Step Off/On      0,1=Off,On |
|   163   |   1   |   0,1   |  Step 10 Active Step Off/On      0,1=Off,On |
|   163   |   2   |   0,1   |  Step 11 Active Step Off/On      0,1=Off,On |
|   163   |   3   |   0,1   |  Step 12 Active Step Off/On      0,1=Off,On |
|   163   |   4   |   0,1   |  Step 13 Active Step Off/On      0,1=Off,On |
|   163   |   5   |   0,1   |  Step 14 Active Step Off/On      0,1=Off,On |
|   163   |   6   |   0,1   |  Step 15 Active Step Off/On      0,1=Off,On |
|   163   |   7   |   0,1   |  Step 16 Active Step Off/On      0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   164   | L:0~7 |100~3000 |  BPM                    100~3000=10.0~300.0 |
|   165   | H:0~3 |         |                                             |
+---------+-------+---------+---------------------------------------------+
|   166   |       |  1~16   |  Step Length                                |
+---------+-------+---------+---------------------------------------------+
|   167   |       |  0~4    |  Step Resolution 0~4 = 1/16,1/8,1/4,1/2,1/1 |
+---------+-------+---------+---------------------------------------------+
|   168   |       | -75~+75 |  Swing                                      |
+---------+-------+---------+---------------------------------------------+
|   169   |       |  0~72   |  Default Gate Time             0~72=0%~100% |
+---------+-------+---------+---------------------------------------------+
|   170   |   0   |   0,1   |  Step  1 Off/On                  0,1=Off,On |
|   170   |   1   |   0,1   |  Step  2 Off/On                  0,1=Off,On |
|   170   |   2   |   0,1   |  Step  3 Off/On                  0,1=Off,On |
|   170   |   3   |   0,1   |  Step  4 Off/On                  0,1=Off,On |
|   170   |   4   |   0,1   |  Step  5 Off/On                  0,1=Off,On |
|   170   |   5   |   0,1   |  Step  6 Off/On                  0,1=Off,On |
|   170   |   6   |   0,1   |  Step  7 Off/On                  0,1=Off,On |
|   170   |   7   |   0,1   |  Step  8 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   171   |   0   |   0,1   |  Step  9 Off/On                  0,1=Off,On |
|   171   |   1   |   0,1   |  Step 10 Off/On                  0,1=Off,On |
|   171   |   2   |   0,1   |  Step 11 Off/On                  0,1=Off,On |
|   171   |   3   |   0,1   |  Step 12 Off/On                  0,1=Off,On |
|   171   |   4   |   0,1   |  Step 13 Off/On                  0,1=Off,On |
|   171   |   5   |   0,1   |  Step 14 Off/On                  0,1=Off,On |
|   171   |   6   |   0,1   |  Step 15 Off/On                  0,1=Off,On |
|   171   |   7   |   0,1   |  Step 16 Off/On                  0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   172   |   0   |   0,1   |  Step  1 Motion Off/On           0,1=Off,On |
|   172   |   1   |   0,1   |  Step  2 Motion Off/On           0,1=Off,On |
|   172   |   2   |   0,1   |  Step  3 Motion Off/On           0,1=Off,On |
|   172   |   3   |   0,1   |  Step  4 Motion Off/On           0,1=Off,On |
|   172   |   4   |   0,1   |  Step  5 Motion Off/On           0,1=Off,On |
|   172   |   5   |   0,1   |  Step  6 Motion Off/On           0,1=Off,On |
|   172   |   6   |   0,1   |  Step  7 Motion Off/On           0,1=Off,On |
|   172   |   7   |   0,1   |  Step  8 Motion Off/On           0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   173   |   0   |   0,1   |  Step  9 Motion Off/On           0,1=Off,On |
|   173   |   1   |   0,1   |  Step 10 Motion Off/On           0,1=Off,On |
|   173   |   2   |   0,1   |  Step 11 Motion Off/On           0,1=Off,On |
|   173   |   3   |   0,1   |  Step 12 Motion Off/On           0,1=Off,On |
|   173   |   4   |   0,1   |  Step 13 Motion Off/On           0,1=Off,On |
|   173   |   5   |   0,1   |  Step 14 Motion Off/On           0,1=Off,On |
|   173   |   6   |   0,1   |  Step 15 Motion Off/On           0,1=Off,On |
|   173   |   7   |   0,1   |  Step 16 Motion Off/On           0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
| 174~175 |       |         |  Motion Slot 1 Parameter           *note S2 |
+---------+-------+---------+---------------------------------------------+
| 176~177 |       |         |  Motion Slot 2 Parameter           *note S2 |
+---------+-------+---------+---------------------------------------------+
| 178~179 |       |         |  Motion Slot 3 Parameter           *note S2 |
+---------+-------+---------+---------------------------------------------+
| 180~181 |       |         |  Motion Slot 4 Parameter           *note S2 |
+---------+-------+---------+---------------------------------------------+
|   182   |   0   |         |  Motion Slot 1 Step  1 Off/On    0,1=Off,On |
|   182   |   1   |         |  Motion Slot 1 Step  2 Off/On    0,1=Off,On |
|   182   |   2   |         |  Motion Slot 1 Step  3 Off/On    0,1=Off,On |
|   182   |   3   |         |  Motion Slot 1 Step  4 Off/On    0,1=Off,On |
|   182   |   4   |         |  Motion Slot 1 Step  5 Off/On    0,1=Off,On |
|   182   |   5   |         |  Motion Slot 1 Step  6 Off/On    0,1=Off,On |
|   182   |   6   |         |  Motion Slot 1 Step  7 Off/On    0,1=Off,On |
|   182   |   7   |         |  Motion Slot 1 Step  8 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
|   183   |   0   |         |  Motion Slot 1 Step  9 Off/On    0,1=Off,On |
|   183   |   1   |         |  Motion Slot 1 Step 10 Off/On    0,1=Off,On |
|   183   |   2   |         |  Motion Slot 1 Step 11 Off/On    0,1=Off,On |
|   183   |   3   |         |  Motion Slot 1 Step 12 Off/On    0,1=Off,On |
|   183   |   4   |         |  Motion Slot 1 Step 13 Off/On    0,1=Off,On |
|   183   |   5   |         |  Motion Slot 1 Step 14 Off/On    0,1=Off,On |
|   183   |   6   |         |  Motion Slot 1 Step 15 Off/On    0,1=Off,On |
|   183   |   7   |         |  Motion Slot 1 Step 16 Off/On    0,1=Off,On |
+---------+-------+---------+---------------------------------------------+
| 184~185 |       |         |  Motion Slot 2 Step Off/On (same as Slot 1) |
+---------+-------+---------+---------------------------------------------+
| 186~187 |       |         |  Motion Slot 3 Step Off/On (same as Slot 1) |
+---------+-------+---------+---------------------------------------------+
| 188~189 |       |         |  Motion Slot 4 Step Off/On (same as Slot 1) |
+---------+-------+---------+---------------------------------------------+
| 190~241 |       |         |  Step 1 Event Data                 *note S3 |
| 242~293 |       |         |  Step 2 Event Data                 *note S3 |
|   :     |       |         |                                             |
|   :     |       |         |                                             |
| 426~1021|       |         |  Step 16 Event Data                *note S3 |
+---------+-------+---------+---------------------------------------------+
|  1022   |       |  0~72   |  ARP Gate Time               0~72 = 0%~100% |
+---------+-------+---------+---------------------------------------------+
|  1023   |       |  0~10   |  ARP Rate                          *note S4 |
+---------+-------+---------+---------------------------------------------+

*Note G1
Korg's table shows
|   17    |       |  0,1    |  PORTAMENTO                           0~127 |
I assume this should be
|   17    |       |  0~127  |  PORTAMENTO                           0~127 |

*Note G2
Korg's note P3 table shows 1, 2, 2, 3 but should be 1, 2, 3, 4
Korg's note P2 shows 0~73:5th but it should be more like 0~1:Mono 2~73:5th
I don't know if the breakover is from 1 to 2 or greater, but I will assume that.

"""

# Simple translation functions
fn_sync = lambda src, dest: 1 - src.sync
fn_ring = lambda src, dest: 1 - src.ring
fn_delay_on_off = lambda src, dest: 0 if src.delay_output_routing == 0 else 1
fn_str_pred = lambda src, dest: "PRED"
fn_str_sq = lambda src, dest: "SQ"
fn_target = lambda src, dest: 0 if src.lfo_eg == 2 else 1
fn_lfo_mode = lambda src, dest: 1 if src.lfo_bpm_sync == 0 else 2
fn_cutoff_velocity = lambda src, dest: (0, 63, 127)[src.cutoff_velocity]
fn_multi_octave = lambda src, dest: 0 if src.vco_1_octave == 0 else src.vco_1_octave - 1
fn_voice_mode_type = lambda src, dest: {0:4, 1:4, 2:3, 3:2, 4:2, 5:4, 6:1, 7:4}[src.voice_mode]


def fn_voice_mode_depth(src, dest):
    """
    -XD-
    *note P3 (VOICE MODE TYPE)
        1:ARP, 2:CHORD (Mono verified), 3:UNISON, 4:POLY
    *note P2 (VOICE MODE DEPTH)
        [POLY] 0~255:Poly, 256~1023:Duo 0~1023
        [UNISON] 0 ~ 1023: Detune 0 Cent
        [CHORD] 0~1:Mono, 2~73:5th, 74~146:sus2, 147~219:m, 220~292:Maj, 293~365:sus4,
            366~438:m7, 439~511:7, 512~585:7sus4, 586~658:Maj7, 659~731:aug,
            732~804:dim, 805~877:m7b5, 878~950:mMaj7, 951~1023:Maj7b5
        [ARP] unchanged

    -OG-
    *note P11 (VOICE MODE)
        0:POLY, 1:DUO, 2:UNISON, 3:MONO, 4:CHORD, 5:DELAY, 6:ARP, 7:SIDECHAIN

    *note P12 (VOICE MODE DEPTH)
        [POLY] 0~1023:Invert 0~8
        [DUO],[UNISON] 0~1023:Detune 0 Cent ~ 50 Cent
        [MONO] 0~1023:Sub 0~1023
        [CHORD] unchanged for non-mono mode
        [DELAY] N/A
        [ARP] unchanged
        [SIDECHAIN] N/A
    """
    if src.voice_mode == 1:
        # DUO; this handling could well be wrong
        return src.voice_mode_depth + 256
    elif src.voice_mode == 3:
        # MONO
        return 0
    else:
        return src.voice_mode_depth


"""
A translation table for converting from minilogue OG patch data. Each tuple takes one of
the forms

('label', 'binary-format string', 'src1_name')
('label', 'binary-format string', p), where p is an integer
('label', 'binary-format string', f, arg1, ..., argN), where f is a function with optional args

"""
minilogue_xd_patch_struct = (
    # 0
    ("str_PROG", "4s", "str_PROG"),
    ("program_name", "12s", "program_name"),
    ("octave", "B", "keyboard_octave"),
    ("portamento", "B", "portamento_time"),
    ("key_trig", "B", 0),
    ("voice_mode_depth", "H", fn_voice_mode_depth),
    ("voice_mode_type", "B", fn_voice_mode_type),
    ("vco_1_wave", "B", "vco_1_wave"),
    ("vco_1_octave", "B", "vco_1_octave"),
    ("vco_1_pitch", "H", "vco_1_pitch"),
    ("vco_1_shape", "H", "vco_1_shape"),
    ("vco_2_wave", "B", "vco_2_wave"),
    ("vco_2_octave", "B", "vco_2_octave"),
    ("vco_2_pitch", "H", "vco_2_pitch"),
    ("vco_2_shape", "H", "vco_2_shape"),
    ("sync", "B", fn_sync),
    ("ring", "B", fn_ring),
    ("cross_mod_depth", "H", "cross_mod_depth"),
    ("multi_type", "B", 0),
    ("select_noise", "B", 1),
    ("select_vpm", "B", 6),
    ("select_user", "B", 0),
    ("shape_noise", "H", 1),
    ("shape_vpm", "H", 6),
    ("shape_user", "H", 0),
    ("shift_shape_noise", "H", 0),
    # 50
    ("shift_shape_vpm", "H", 0),
    ("shift_shape_user", "H", 0),
    ("vco1_level", "H", "vco_1_level"),
    ("vco2_level", "H", "vco_2_level"),
    ("multi_level", "H", "noise_level"),
    ("cutoff", "H", "cutoff"),
    ("resonance", "H", "resonance"),
    ("cutoff_drive", "B", 0),
    ("cutoff_keyboard_track", "B", "cutoff_kbd_track"),
    ("amp_eg_attack", "H", "amp_eg_attack"),
    ("amp_eg_decay", "H", "amp_eg_decay"),
    ("amp_eg_sustain", "H", "amp_eg_sustain"),
    ("amp_eg_release", "H", "amp_eg_release"),
    ("eg_attack", "H", "amp_attack"),
    ("eg_decay", "H", "amp_decay"),
    ("eg_int", "H", "cutoff_eg_int"),
    ("eg_target", "B", fn_target),
    ("lfo_wave", "B", "lfo_wave"),
    ("lfo_mode", "B", fn_lfo_mode),
    ("lfo_rate", "H", "lfo_rate"),
    ("lfo_int", "H", "lfo_int"),
    ("lfo_target", "B", "lfo_target"),
    ("mod_fx_on_off", "B", 0),
    ("mod_fx_type", "B", 0),
    ("mod_fx_chorus", "B", 0),
    ("mod_fx_ensemble", "B", 0),
    ("mod_fx_phaser", "B", 0),
    ("mod_fx_flanger", "B", 0),
    ("mod_fx_user", "B", 0),
    ("mod_fx_time", "H", 0),
    ("mod_fx_depth", "H", 0),
    ("delay_on_off", "B", fn_delay_on_off),
    # 100
    ("delay_sub_type", "B", 3),
    ("delay_time", "H", "delay_time"),
    ("delay_depth", "H", "delay_feedback"),
    ("reverb_on_off", "B", 0),
    ("reverb_sub_type", "B", 0),
    ("reverb_time", "H", 0),
    ("reverb_depth", "H", 0),
    ("bend_range_plus", "B", "bend_range_plus"),
    ("bend_range_minus", "B", "bend_range_minus"),
    ("joystick_assign_plus", "B", 22),
    ("joystick_range_plus", "B", 100),
    ("joystick_assign_minus", "B", 12),
    ("joystick_range_minus", "B", 100),
    ("cv_in_mode", "B", 0),
    ("cv_in_1_assign", "B", 0),
    ("cv_in_1_range", "B", 100),
    ("cv_in_2_assign", "B", 0),
    ("cv_in_2_range", "B", 100),
    ("micro_tuning", "B", 0),
    ("scale_key", "B", 12),
    ("program_tuning", "B", 50),
    ("lfo_key_sync", "B", "lfo_key_sync"),
    ("lfo_voice_sync", "B", "lfo_voice_sync"),
    ("lfo_target_osc", "B", 0),
    ("cutoff_velocity", "B", fn_cutoff_velocity),
    ("amp_velocity", "B", "amp_velocity"),
    ("multi_octave", "B", fn_multi_octave),
    ("multi_routing", "B", 0),
    ("eg_legato", "B", 0),
    ("portamento_mode", "B", "portamento_mode"),
    ("portamento_bpm_sync", "B", "portamento_bpm"),
    ("program_level", "B", 102),
    ("vpm_param1_feedback", "B", 199),
    ("vpm_param2_noise_depth", "B", 199),
    ("vpm_param3_shapemodint", "B", 199),
    ("vpm_param4_mod_attack", "B", 199),
    ("vpm_param5_mod_decay", "B", 199),
    ("vpm_param6_modkeytrack", "B", 199),
    ("user_param1", "B", 0),
    ("user_param2", "B", 0),
    ("user_param3", "B", 0),
    ("user_param4", "B", 0),
    ("user_param5", "B", 0),
    ("user_param6", "B", 0),
    ("user_param5_6_r_r_type", "B", 0),
    ("user_param1_2_3_4_type", "B", 0),
    # 150
    ("program_transpose", "B", 13),
    ("delay_dry_wet", "H", 1024),
    ("reverb_dry_wet", "H", 1024),
    ("midi_after_touch_assign", "B", 12),
    ("str_PRED", "4s", fn_str_pred),
    ("str_SQ", "2s", fn_str_sq),
    ("step_1_16_active_step", "<H", 65535),
    ("bpm", "H", "bpm"),
    ("step_length", "B", "step_length"),
    ("step_resolution", "B", "step_resolution"),
    ("swing", "B", "swing"),
    ("default_gate_time", "B", "default_gate_time"),
    ("step1_16", "<H", "step1_16"),
    ("step1_16_motion", "<H", 0),                                   # Fix this
    ("motion_slot_1_parameter", "<H", "motion_slot_1_parameter"),
    ("motion_slot_2_parameter", "<H", "motion_slot_2_parameter"),
    ("motion_slot_3_parameter", "<H", "motion_slot_3_parameter"),
    ("motion_slot_4_parameter", "<H", "motion_slot_4_parameter"),
    ("motion_slot_1_step1_16", "<H", "motion_slot_1_step1_16"),
    ("motion_slot_2_step1_16", "<H", "motion_slot_2_step1_16"),
    ("motion_slot_3_step1_16", "<H", "motion_slot_3_step1_16"),
    ("motion_slot_4_step1_16", "<H", "motion_slot_4_step1_16"),
    # 190
    ("step_1_event_data", "52p", 52*b'\x00'),    # Fix/translate these
    ("step_2_event_data", "52p", 52*b'\x00'),
    ("step_3_event_data", "52p", 52*b'\x00'),
    ("step_4_event_data", "52p", 52*b'\x00'),
    ("step_5_event_data", "52p", 52*b'\x00'),
    ("step_6_event_data", "52p", 52*b'\x00'),
    ("step_7_event_data", "52p", 52*b'\x00'),
    ("step_8_event_data", "52p", 52*b'\x00'),
    ("step_9_event_data", "52p", 52*b'\x00'),
    ("step_10_event_data", "52p", 52*b'\x00'),
    ("step_11_event_data", "52p", 52*b'\x00'),
    ("step_12_event_data", "52p", 52*b'\x00'),
    ("step_13_event_data", "52p", 52*b'\x00'),
    ("step_14_event_data", "52p", 52*b'\x00'),
    ("step_15_event_data", "52p", 52*b'\x00'),
    ("step_16_event_data", "52p", 52*b'\x00'),
    # 1022
    ("arp_gate_time", "B", "default_gate_time"),
    ("arp_rate", "B", 10),
)


minilogue_og_patch_struct = (
    # 0
    ("str_PROG", "4s"),
    ("program_name", "12s"),
    ("reserved1", "4B"),
    ("vco_1_pitch_b2_9", "B"),
    ("vco_1_shape_b2_9", "B"),
    ("vco_2_pitch_b2_9", "B"),
    ("vco_2_shape_b2_9", "B"),
    ("cross_mod_depth_b2_9", "B"),
    ("vco_2_pitch_eg_int_b2_9", "B"),
    ("vco_1_level_b2_9", "B"),
    ("vco_2_level_b2_9", "B"),
    ("noise_level_b2_9", "B"),
    ("cutoff_b2_9", "B"),
    ("resonance_b2_9", "B"),
    ("cutoff_eg_int_b2_9", "B"),
    ("reserved2", "B"),
    ("amp_velocity", "B"),
    ("amp_eg_attack_b2_9", "B"),
    ("amp_eg_decay_b2_9", "B"),
    ("amp_eg_sustain_b2_9", "B"),
    ("amp_eg_release_b2_9", "B"),
    ("eg_attack_b2_9", "B"),
    ("eg_decay_b2_9", "B"),
    ("eg_sustain_b2_9", "B"),
    ("eg_release_b2_9", "B"),
    ("lfo_rate_b2_9", "B"),
    ("lfo_int_b2_9", "B"),
    ("reserved3", "5B"),
    ("delay_hi_pass_cutoff_b2_9", "B"),
    # 50
    ("delay_time_b2_9", "B"),
    ("delay_feedback_b2_9", "B"),
    ("vco_1_pitch_shape_octave_wave", "B"),
    ("vco_2_pitch_shape_octave_wave", "B"),
    ("xmod_vco2_pitch_vco1_lvl_vco2_lvl", "B"),
    ("sync_ring_noise_cutoff_res", "B"),
    ("cutoff_params", "B"),
    ("amp_adsr", "B"),
    ("eg_adsr", "B"),
    ("lfo_rate_int_tgt_eg", "B"),
    ("lfo_wave_dly", "B"),
    ("portamento_time", "B"),
    ("delay_b0_1", "B"),
    ("reserved4", "B"),
    ("voice_mode_and_depth_b0_1", "B"),
    ("reserved5", "B"),
    ("bend_range_plusminus", "B"),
    ("reserved6", "2B"),
    ("lfo_portamento_params", "B"),
    ("voice_mode_depth_b2_9", "B"),
    ("program_level", "B"),
    ("slider_assign", "B"),
    ("keyboard_octave", "B"),
    ("reserved7", "22B"),
    ("str_SEQD", "4s"),
    # 100
    ("bpm", "<H"),
    ("reserved8", "B"),
    ("step_length", "B"),
    ("swing", "B"),
    ("default_gate_time", "B"),
    ("step_resolution", "B"),
    ("reserved9", "B"),
    ("step1_16", "<H"),
    ("step1_16_switch", "<H"),
    ("motion_slot_1_parameter", "<H"),
    ("motion_slot_2_parameter", "<H"),
    ("motion_slot_3_parameter", "<H"),
    ("motion_slot_4_parameter", "<H"),
    ("motion_slot_1_step1_16", "<H"),
    ("motion_slot_2_step1_16", "<H"),
    ("motion_slot_3_step1_16", "<H"),
    ("motion_slot_4_step1_16", "<H"),
    # 128
    ("step_1_event_data", "20B"),
    ("step_2_event_data", "20B"),
    ("step_3_event_data", "20B"),
    ("step_4_event_data", "20B"),
    ("step_5_event_data", "20B"),
    ("step_6_event_data", "20B"),
    ("step_7_event_data", "20B"),
    ("step_8_event_data", "20B"),
    ("step_9_event_data", "20B"),
    ("step_10_event_data", "20B"),
    ("step_11_event_data", "20B"),
    ("step_12_event_data", "20B"),
    ("step_13_event_data", "20B"),
    ("step_14_event_data", "20B"),
    ("step_15_event_data", "20B"),
    ("step_16_event_data", "20B"),
)


"""
A translation table for normalising the minilogue OG patch data by combining
fields that are split across different fields. Each tuple takes the form

('dest_name', 'src1_name_XX_x', 'src2_name_XX_x', ..., 'srcN_name_XX_x'), where N >= 1.

'dest_name' is the name of the new field to be created.
'src1_name_XX_x' contains 'src1_name', the name of a source field, a hex bit mask XX and
a 2's-complement single-hex-digit x encoding the number of bits to shift up (+ve values)
or down (-ve) the masked values before adding them to the destination.

+---------------------+----------------------------+-----------------------
|                     |        offset for          |offset for lower 2bits
|  Description        |        upper 8bits         +----------+------------
|                     |                            |   Byte   |    Bit
+---------------------+----------------------------+----------+------------
| VCO 1 PITCH         |20 vco_1_pitch_b2_9         | 52 vco_1_pitch_shape_octave_wave |0~1|
| VCO 1 SHAPE         |21 vco_1_shape_b2_9         | 52 vco_1_pitch_shape_octave_wave |2~3|
| VCO 2 PITCH         |22 vco_2_pitch_b2_9         | 53 vco_2_pitch_shape_octave_wave |0~1|
| VCO 2 SHAPE         |23 vco_2_shape_b2_9         | 53 vco_2_pitch_shape_octave_wave |2~3|
| CROSS MOD DEPTH     |24 cross_mod_depth_b2_9     | 54 xmod_vco2_pitch_vco1_lvl_vco2_lvl |0~1|
| VCO 2 PITCH EG INT  |25 vco_2_pitch_eg_int_b2_9  | 54 xmod_vco2_pitch_vco1_lvl_vco2_lvl |2~3|
| VCO 1 LEVEL         |26 vco_1_level_b2_9         | 54 xmod_vco2_pitch_vco1_lvl_vco2_lvl |4~5|
| VCO 2 LEVEL         |27 vco_2_level_b2_9         | 54 xmod_vco2_pitch_vco1_lvl_vco2_lvl |6~7|
| NOISE LEVEL         |28 noise_level_b2_9         | 55 sync_ring_noise_cutoff_res |2~3|
| CUTOFF              |29 cutoff_b2_9              | 55 sync_ring_noise_cutoff_res |4~5|
| RESONANCE           |30 resonance_b2_9           | 55 sync_ring_noise_cutoff_res |6~7|
| CUTOFF EG INT       |31 cutoff_eg_int_b2_9       | 56 cutoff_params |0~1|
| AMP EG ATTACK       |34 amp_eg_attack_b2_9       | 57 amp_adsr |0~1|
| AMP EG DECAY        |35 amp_eg_decay_b2_9        | 57 amp_adsr |2~3|
| AMP EG SUSTAIN      |36 amp_eg_sustain_b2_9      | 57 amp_adsr |4~5|
| AMP EG RELEASE      |37 amp_eg_release_b2_9      | 57 amp_adsr |6~7|
| AMP ATTACK          |38 eg_attack_b2_9           | 58 eg_adsr |0~1|
| AMP DECAY           |39 eg_decay_b2_9            | 58 eg_adsr |2~3|
| AMP SUSTAIN         |40 eg_sustain_b2_9          | 58 eg_adsr |4~5|
| AMP RELEASE         |41 eg_release_b2_9          | 58 eg_adsr |6~7| !Note: Korg docs say 59
| LFO RATE            |42 lfo_rate_b2_9            | 60 lfo_wave_dly |0~1|
| LFO INT             |43 lfo_int_b2_9             | 60 lfo_wave_dly |2~3|
| DELAY HI PASS CUTOFF|49 delay_hi_pass_cutoff_b2_9| 62 delay_b0_1 |2~3|
| DELAY TIME          |50 delay_time_b2_9          | 62 delay_b0_1 |4~5|
| DELAY FEEDBACK      |51 delay_feedback_b2_9      | 62 delay_b0_1 |6~7|
| VOICE MODE DEPTH    |70 voice_mode_depth_b2_9    | 64 voice_mode |4~5|
+---------------------+----------------------------+----------+------------
"""

minilogue_og_patch_normalisation = (
    ("vco_1_pitch", "vco_1_pitch_b2_9_FF_2", "vco_1_pitch_shape_octave_wave_03_0"),
    ("vco_1_shape", "vco_1_shape_b2_9_FF_2", "vco_1_pitch_shape_octave_wave_0C_E"),
    ("vco_1_octave", "vco_1_pitch_shape_octave_wave_30_C"),
    ("vco_1_wave", "vco_1_pitch_shape_octave_wave_C0_A"),
    ("vco_2_pitch", "vco_2_pitch_b2_9_FF_2", "vco_2_pitch_shape_octave_wave_03_0"),
    ("vco_2_shape", "vco_2_shape_b2_9_FF_2", "vco_2_pitch_shape_octave_wave_0C_E"),
    ("vco_2_octave", "vco_2_pitch_shape_octave_wave_30_C"),
    ("vco_2_wave", "vco_2_pitch_shape_octave_wave_C0_A"),
    ("cross_mod_depth", "cross_mod_depth_b2_9_FF_2", "xmod_vco2_pitch_vco1_lvl_vco2_lvl_03_0"),
    ("vco_2_pitch_eg_int", "vco_2_pitch_eg_int_b2_9_FF_2", "xmod_vco2_pitch_vco1_lvl_vco2_lvl_0C_E"),
    ("vco_1_level", "vco_1_level_b2_9_FF_2", "xmod_vco2_pitch_vco1_lvl_vco2_lvl_30_C"),
    ("vco_2_level", "vco_2_level_b2_9_FF_2", "xmod_vco2_pitch_vco1_lvl_vco2_lvl_C0_A"),
    ("noise_level", "noise_level_b2_9_FF_2", "sync_ring_noise_cutoff_res_0C_E"),
    ("cutoff", "cutoff_b2_9_FF_2", "sync_ring_noise_cutoff_res_30_C"),
    ("resonance", "resonance_b2_9_FF_2", "sync_ring_noise_cutoff_res_C0_A"),
    ("sync", "sync_ring_noise_cutoff_res_01_0"),
    ("ring", "sync_ring_noise_cutoff_res_02_F"),
    ("cutoff_eg_int", "cutoff_eg_int_b2_9_FF_2", "cutoff_params_03_0"),
    ("cutoff_velocity", "cutoff_params_0C_E"),
    ("cutoff_kbd_track", "cutoff_params_30_C"),
    ("cutoff_type", "cutoff_params_40_A"),
    ("amp_eg_attack", "amp_eg_attack_b2_9_FF_2", "amp_adsr_03_0"),
    ("amp_eg_decay", "amp_eg_decay_b2_9_FF_2", "amp_adsr_0C_E"),
    ("amp_eg_sustain", "amp_eg_sustain_b2_9_FF_2", "amp_adsr_30_C"),
    ("amp_eg_release", "amp_eg_release_b2_9_FF_2", "amp_adsr_C0_A"),
    ("amp_attack", "eg_attack_b2_9_FF_2", "eg_adsr_03_0"),
    ("amp_decay", "eg_decay_b2_9_FF_2", "eg_adsr_0C_E"),
    ("amp_sustain", "eg_sustain_b2_9_FF_2", "eg_adsr_30_C"),
    ("amp_release", "eg_release_b2_9_FF_2", "eg_adsr_C0_A"),
    ("lfo_rate", "lfo_rate_b2_9_FF_2", "lfo_rate_int_tgt_eg_03_0"),
    ("lfo_int", "lfo_int_b2_9_FF_2", "lfo_rate_int_tgt_eg_0C_E"),
    ("lfo_target", "lfo_rate_int_tgt_eg_30_C"),
    ("lfo_eg", "lfo_rate_int_tgt_eg_C0_A"),
    ("lfo_wave", "lfo_wave_dly_03_0"),
    ("delay_output_routing", "lfo_wave_dly_C0_A"),
    ("delay_hi_pass_cutoff", "delay_hi_pass_cutoff_b2_9_FF_2", "delay_b0_1_0C_E"),
    ("delay_time", "delay_time_b2_9_FF_2", "delay_b0_1_30_C"),
    ("delay_feedback", "delay_feedback_b2_9_FF_2", "delay_b0_1_C0_A"),
    ("voice_mode", "voice_mode_and_depth_b0_1_07_0"),
    ("voice_mode_depth", "voice_mode_depth_b2_9_FF_2", "voice_mode_and_depth_b0_1_30_C"),
    ("bend_range_plus", "bend_range_plusminus_0F_0"),
    ("bend_range_minus", "bend_range_plusminus_F0_C"),
    ("lfo_key_sync", "lfo_portamento_params_01_0"),
    ("lfo_bpm_sync", "lfo_portamento_params_02_F"),
    ("lfo_voice_sync", "lfo_portamento_params_04_E"),
    ("portamento_bpm", "lfo_portamento_params_08_D"),
    ("portamento_mode", "lfo_portamento_params_10_C"),
)


minilogue_og_postnormalisation_deletions = (
    "vco_1_pitch_b2_9",
    "vco_1_shape_b2_9",
    "vco_1_pitch_shape_octave_wave",
    "vco_2_pitch_b2_9",
    "vco_2_shape_b2_9",
    "vco_2_pitch_shape_octave_wave",
    "cross_mod_depth_b2_9",
    "vco_2_pitch_eg_int_b2_9",
    "vco_1_level_b2_9",
    "vco_2_level_b2_9",
    "noise_level_b2_9",
    "cutoff_b2_9",
    "resonance_b2_9",
    "cutoff_eg_int_b2_9",
    "amp_eg_attack_b2_9",
    "amp_eg_decay_b2_9",
    "amp_eg_sustain_b2_9",
    "amp_eg_release_b2_9",
    "eg_attack_b2_9",
    "eg_decay_b2_9",
    "eg_sustain_b2_9",
    "eg_release_b2_9",
    "lfo_rate_b2_9",
    "lfo_int_b2_9",
    "delay_hi_pass_cutoff_b2_9",
    "delay_time_b2_9",
    "delay_feedback_b2_9",
    "delay_b0_1",
    "voice_mode_depth_b2_9",
    "voice_mode_and_depth_b0_1",
    "bend_range_plusminus",
    "xmod_vco2_pitch_vco1_lvl_vco2_lvl",
    "sync_ring_noise_cutoff_res",
    "cutoff_params",
    "amp_adsr",
    "eg_adsr",
    "lfo_rate_int_tgt_eg",
    "lfo_wave_dly",
    "lfo_portamento_params",
)


prog_info_template = """\
<?xml version="1.0" encoding="UTF-8"?>

<xd_ProgramInformation>
  <Programmer></Programmer>
  <Comment></Comment>
</xd_ProgramInformation>
"""


favorite_template = """\
<?xml version="1.0" encoding="UTF-8"?>

<xd_Favorite>
  <Bank>
    <Data>0</Data>
    <Data>1</Data>
    <Data>2</Data>
    <Data>3</Data>
    <Data>4</Data>
    <Data>5</Data>
    <Data>6</Data>
    <Data>7</Data>
  </Bank>
  <Bank>
    <Data>8</Data>
    <Data>9</Data>
    <Data>10</Data>
    <Data>11</Data>
    <Data>12</Data>
    <Data>13</Data>
    <Data>14</Data>
    <Data>15</Data>
  </Bank>
</xd_Favorite>
"""


import sys
import click
from zipfile import ZipFile, ZIP_DEFLATED
from attr import attrs, attrib
import struct
from collections import namedtuple
from types import SimpleNamespace, LambdaType, FunctionType
import fnmatch
from pprint import pprint
import copy
import ctypes
import pathlib
import xml.etree.ElementTree as ET
from xml.dom import minidom
import re


XD_PATCH_LENGTH = 1024


class Patch(SimpleNamespace):
    """A simple container class for patch data."""
    pass


patch_value = namedtuple("Field", ["name", "type"])
patch_translation_value = namedtuple("Field", ["name", "type", "source"])


def decode_src_string(src_string):
    src_parts = src_string.split("_")
    src_name = "_".join(src_parts[:-2])
    mask = int(src_parts[-2], base=16)
    shift = int(src_parts[-1], base=16)
    if shift > 7:
        shift = -(~shift & 7) - 1  # decode negative part of signed 2's complement
    return src_name, mask, shift


def signed_shift(val, shift):
    return val << shift if shift >= 0 else val >> -shift


def normalise_og_patch(patch):
    """Expand all encoded fields into a normalised form of patch object. This makes it
    printable and easier to translate. Uses the minilogue_og_patch_normalisation
    translation table:
    ("vco_1_pitch", "vco_1_pitch_b2_9_FF_2", "vco_1_pitch_shape_octave_wave_03_0"),

    Args:
        patch (Patch instance): raw minilogue og patch, read using minilogue_og_patch_struct

    Returns:
        Patch instance: Decoded/expanded patch

    """
    norm_patch = copy.deepcopy(patch)
    for t in minilogue_og_patch_normalisation:
        # t has form ('dest_name', 'src1_name_XX_x', 'src2_name_XX_x', ...)
        dest_name, *srcs = t
        dest_val = 0
        for s in srcs:
            src_name, mask, shift = decode_src_string(s)
            source_val = getattr(patch, src_name) & mask
            dest_val += signed_shift(source_val, shift)
        setattr(norm_patch, dest_name, dest_val)

    # Delete all encoded fields that won't be used anymore
    for t in minilogue_og_postnormalisation_deletions:
        delattr(norm_patch, t)

    return norm_patch


def convert_og_to_xd(patch):
    patch_xd = Patch()
    binary_xd = bytearray(XD_PATCH_LENGTH)

    offset = 0
    for m in minilogue_xd_patch_struct:
        f = patch_translation_value(*m)
        if isinstance(f.source, str):
            value = getattr(patch, f.source)
        elif isinstance(f.source, (int, bytes)):
            value = f.source
        elif isinstance(f.source, (LambdaType, FunctionType)):
            value = f.source(patch, patch_xd)
        else:
            raise(Exception('Unknown patch field type'))

        setattr(patch_xd, f.name, value)
        if isinstance(value, str):
            value = bytes(value, 'utf-8')
        struct.pack_into(f.type, binary_xd, offset, value)
        offset += struct.calcsize(f.type)

    return patch_xd, binary_xd


def zip_progbins(zipobj):
    """Returns an ordered list of all the contained .prog_bin patch block names

    Args:
        zipobj (zipfile object): patch file or library zipfile object

    Returns:
        list: ordered list

    """
    names = zipobj.namelist()
    names = sorted(fnmatch.filter(names, "*.prog_bin"))
    return names


def program_name(data):
    """Returns the patch name

    Args:
        data (packed binary string): patch data

    Returns:
        str: name

    """
    name = struct.unpack_from("12s", data, offset=4)[0].decode("utf-8").strip("\x00")
    return name


def patch_type(data):
    """Identify patch data as being a minilogue xd or og patch by attempting to read
    from a location that is only valid for the xd.

    Args:
        data (packed binary string): patch data

    Returns:
        str: One of {"xd", "og"}

    """
    try:
        struct.unpack_from("B", data, offset=1000)
        minilogue_type = "xd"
    except struct.error:
        minilogue_type = "og"
    return minilogue_type


def parse_patchdata(data):
    patch = Patch()
    patch.minilogue_type = patch_type(data)
    assert(patch.minilogue_type == "og")

    offset = 0
    for m in minilogue_og_patch_struct:
        f = patch_value(*m)
        value = struct.unpack_from(f.type, data, offset=offset)[0]
        setattr(patch, f.name, value)
        offset += struct.calcsize(f.type)

    new_patch = normalise_og_patch(patch)

    return new_patch


def id_from_name(zipobj, name):
    for i, p in enumerate(zip_progbins(zipobj)):
        patchdata = zipobj.read(p)
        prgname = program_name(patchdata)
        if prgname != name:
            continue
        ident = i + 1
        break
    else:
        print("No patch named", name)
    return ident


def fileinfo_xml(non_init_patch_ids):
    """Build FileInformation.xml metadata file.

    Args:
        non_init_patch_ids (list of ints): 0-based list of non-Init-Program patches

    Returns:
        str: formatted xml

    """
    # create the file structure
    root = ET.Element('KorgMSLibrarian_Data')
    product = ET.SubElement(root, 'Product')
    product.text = 'minilogue xd'
    contents = ET.SubElement(root, 'Contents')

    contents.set('NumProgramData', str(len(non_init_patch_ids)))
    contents.set('NumPresetInformation', '0')
    contents.set('NumTuneScaleData', '0')
    contents.set('NumTuneOctData', '0')

    if len(non_init_patch_ids) == 0:
        contents.set('NumFavoriteData', '0')
    else:
        contents.set('NumFavoriteData', '1')
        fave = ET.SubElement(contents, 'FavoriteData')
        fave_info = ET.SubElement(fave, 'File')
        fave_info.text = 'FavoriteData.fav_data'

    for i in non_init_patch_ids:
        prog = ET.SubElement(contents, 'ProgramData')
        prog_info = ET.SubElement(prog, 'Information')
        prog_info.text = f'Prog_{i:03d}.prog_info'
        prog_bin = ET.SubElement(prog, 'ProgramBinary')
        prog_bin.text = f'Prog_{i:03d}.prog_bin'

    # https://stackoverflow.com/a/3095723
    pretty_version = minidom.parseString(
        ET.tostring(root, encoding='utf-8', method='xml')
    ).toprettyxml(indent='  ')

    return pretty_version


@click.command()
@click.argument('filename', type=click.Path(exists=True))
@click.option("--match_name", "-n", help="Dump the patch with name NAME")
@click.option("--match_ident", "-i", type=int, help="Dump the patch with ident ID")
@click.option("--verbose", "-v", is_flag=True, help="List the patch contents")
@click.option("--md5", "-m", is_flag=True, help="List patch checksums")
def translate(filename, match_name, match_ident, verbose, md5):
    """Dumps contents of FILENAME to stdout. Supports both minilogue og and xd patch files."""
    zipobj = ZipFile(filename, "r", compression=ZIP_DEFLATED, compresslevel=9)
    proglist = zip_progbins(zipobj)

    if match_name is not None:
        match_ident = id_from_name(zipobj, match_name)

    if match_ident is not None:
        proglist = [proglist[match_ident - 1]]

    input_file = pathlib.Path(filename)
    if len(proglist) == 1:
        # https://stackoverflow.com/a/13593932
        stem = re.sub('[^\w\-_\.]', '_', match_name)
        patch_ext = ".mnlgxdprog"
    else:
        stem = input_file.stem
        patch_ext = ".mnlgxdlib"
    output_file = input_file.with_name(stem).with_suffix(patch_ext)

    non_init_patch_ids = []
    with ZipFile(output_file, "w") as xdzip:
        for i, p in enumerate(proglist):
            patchdata = zipobj.read(p)
            prgname = program_name(patchdata)
            if prgname == "Init Program":
                continue
            non_init_patch_ids.append(i)
            print(f"{int(p[5:8])+1:03d}: {prgname}")

            patch = parse_patchdata(patchdata)
            patch_xd, binary_xd = convert_og_to_xd(patch)

            # .prog_bin record/file
            xdzip.writestr(f"Prog_{i:03d}.prog_bin", binary_xd)

            # .prog_info record/file
            xdzip.writestr(f"Prog_{i:03d}.prog_info", prog_info_template)

            if verbose:
                pprint(vars(patch))
                print()

        if len(proglist) > 1:
            # FavoriteData.fav_data record/file
            xdzip.writestr(f"FavoriteData.fav_data", favorite_template)

        # FileInformation.xml record/file
        xdzip.writestr(f"FileInformation.xml", fileinfo_xml(non_init_patch_ids))

        print("Wrote", output_file)


if __name__ == "__main__":
    translate()
